let cards = [
            {
                "id": "84ff18c9-854c-4b0e-843c-994f412221c2",
                "name": "Premise",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>A distant future adventure: Four unlikely heroes are sent on a suicide quest to pierce the viel. It is the far future, in a dystopian world where the surface is uninhabitable.</p>",
                "prose": "",
                "word_count": 31,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "70cd9f54-efda-41c1-9441-1e24824fc246",
                "name": "The city degrades: Without parts, the atmosphere will fail",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>The world outside is overrun by mutants and ghoals. Without the machinery that cleans the air and water, the populace will die. But they need parts - they send the best, but all parties fail. Now they have an idea. Who can survive in the wild? Scoundrels. The worst of the worst. They'll send criminals.</p>",
                "prose": "",
                "word_count": 55,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "08d707ff-b9d3-4834-a053-0d81b98e4226",
                "name": "Character: Joanna",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Former cop. Was framed for corruption; serving a ten year sentence. She became a cop because of the murder of her parents, though she is unaware that her parents were criminals.&nbsp;</p>",
                "prose": "",
                "word_count": 31,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "33b2ad69-9dcf-4587-a1ce-a2b5f0ec866f",
                "name": "Character: Elle",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Assassin for hire. Betrayed by the man who raised her and arrested, she is set to be executed. Absolute psychopath. Seems unaware that other people don't like feeling pain.</p>",
                "prose": "",
                "word_count": 29,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "a515ffb5-1613-484a-952f-be47743dc184",
                "name": "Character: Viggo",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Old ronin, once part of a pirate gang that lived in the wastelands and raided traffic between the cities mad-max style. He betrayed and murdered them after a job gone bad where he discovers the caravan they hit is not transporting weapons, as their leader claims, but families. He hunts down every living member of their gang, ending with Joanna's parents who had settled down in the city. He is a scoundrel to this day, obsessed with expunging all reminders of his past. Joanna's father was the leader of their gang.</p>",
                "prose": "",
                "word_count": 91,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "c98b5d3e-e9a7-40d5-8ac8-53dd428f2429",
                "name": "Character: Lily \"Corpse\" Flower",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Adrogenous child-like hacker. Failed out of college - expelled for their antics; prefers to spend their time plugged into a virtual world. Is currently jailed for hacking the central bank and stealing a lot of money. Spouts a lot of anti-capitalist stuff, but, ya know, they aren't wrong. Immediately develops a crush on Emily.</p>",
                "prose": "",
                "word_count": 54,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "fd1bf059-3181-433b-912b-d004c21f5aac",
                "name": "Character: Emily",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Teenage princess of Crowsnest. She is 16. She is the king's first cousin, but was raised in their household.</p><p>The king is a sickly boy of 12. Her plot begins when the king dies - she immediately seals his rooms and forbids anyone but her to wait upon him. Thus she is seen as a dutiful princess; the doctor, a young man of 20, is convinced to aid her by her charm and empty promises, as he has quite the crush on her - he is seen as too young to be the doctor looking after the king but the princess insists. This despite that she is betrothed. There is also a brigand who has her ear, a mercenary with a group of men, that goads her into later actions. She tries to keep it secret, but one of the councilors lets it slip that the king is ill, and so the king's half-sisters are set to come from their home in another city to visit their brother - a thing Emily must prevent; thus she hires Elle to take care of the two women. The two had been sent to treat with the king of a rival city to form diplomatic relations and possibly find husbands, but were unable to safely return due to deterioration in the wasteland. Meanwhile, Emily forges the king's will, naming herself and any future male heirs as heir to the throne, claiming a wish from her cousin that his sisters marry abroad and that his kingdom does not pass into the hands of their husbands. That isn't how it would work anyway. But now, when news of his half sister's untimely deaths arrive, Emily can declare the king has died and take up the throne. She has grand ideas about reformation - she should be painted as sympathetic; as doing this for a good reason - even if it can't make up for ordering the death of the sisters, one of which is a literal child. The council reluctantly agrees and Emily ascends to the throne. She begins reforms immediately, alienating the guards by putting a brigand in charge. But she is unaware that the journey has changed Elle, and the sisters are alive. Just nine days later the sisters successfully turn the council against her, the doctor is killed, and when the council orders Emily's arrest and Emily orders the guards to arrest the council, the guards side with the council. The brigand, apparently, has been paid off.</p>",
                "prose": "",
                "word_count": 0,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "19bcb9cc-0bc0-45a5-9fee-f4c341c9dd43",
                "name": "Location: Crowfall",
                "date": "0",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Crowfall is an efficient and clean city built inside a canyon. The top is covered with a dome. The city is in the middle far from the walls, down which toxic sludge endlessly drips, fouling the lake beneath the city. The city itself is sealed. Very few leave, fewer still dare venture above the canyon rim. The surface around the canyon is known to be quite inhospitable.</p>",
                "prose": "",
                "word_count": 67,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "f17c1f2b-713b-4f16-9973-392ca26f34b8",
                "name": "Joanna is framed for corruption",
                "date": "14",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "c028f328-0c73-4619-81a9-1904bb56bfe1",
                "name": "Lily finds hints that her mother lives",
                "date": "15",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0,
                "summary_expanded": true,
                "prose_expanded": false
            },
            {
                "id": "0f876e8c-9f20-40ec-9da0-2064e49c03ca",
                "name": "Lily born",
                "date": "3556-08-25",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            },
            {
                "id": "f44131c5-cafb-4b8a-9771-e485f5f6f4a8",
                "name": "Lily's mother is banished from Crowfall",
                "date": "3561-08-02",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>For some crime Lily does not understand, her mother is banished.</p>",
                "prose": "",
                "word_count": 0,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "06a12e37-dc9e-4b97-90cd-b5f5ff19499a",
                "name": "Joanna and Lily become friends",
                "date": "3566-07-12",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Lily is a down on her luck kid stuck in the foster system and turning to crime, Joanna is the cop who thinks she needs to be saved.</p>",
                "prose": "",
                "word_count": 0,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "032f058a-66a4-402e-9217-0d4e5dbab47f",
                "name": "Joanna arrests Elle",
                "date": "3569-07-23",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "5a06b347-faf0-42c0-9949-bee751fa6631",
                "name": "Lily quits school",
                "date": "3571-10-10",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>At this time they are 15.</p>",
                "prose": "",
                "word_count": 0,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "c4e876dc-fe09-4b5d-bf5e-432d6f73dec8",
                "name": "Lily arrested",
                "date": "3576-04-30",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Lily is caught during her hacking spree. She was using information stolen from Joanna, which implicates Joanna as well.</p>",
                "prose": "",
                "word_count": 0,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "7ae5ed24-35f2-41c3-b9c9-df8cfa108592",
                "name": "Viggo meets Emily",
                "date": "3577-01-04",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Perhaps as part of the brigand group she later hires? I would like them to have some kind of history - perhaps he is with a group that captures her on the road as she is traveling back from Mary's wedding, the same group she presses into her service.</p>",
                "prose": "",
                "word_count": 49,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "750f4f9c-0054-4a63-85dc-ab09b7049e0d",
                "name": "King Edward Dies",
                "date": "3578-10-01",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            },
            {
                "id": "82454bd5-ef52-4475-add1-4ce996ab8fdf",
                "name": "Emily hires Elle to deal with the sisters",
                "date": "3578-10-04",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            },
            {
                "id": "0097792b-14b5-4067-bf44-c4ca80eed379",
                "name": "Job Offer",
                "date": "3578-10-05",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Mostly made up, the job offer is to get Elle to the other city so she can carry out the assassination - the rest is just cover. Emily claims that an important artifact has been stolen from the city by the sisters, and their job is to get it back. Specifically, she implicates the elder sister's new husband in the crime, telling them that edward is sickly and this man hopes to press Mary's claim, using the artifact as leverage. The item in question is a regulator for the dome - without it, the dome will not survive the next solar season. Joanna, devoted as always, agrees to retrieve it by any means necessary. But of course, it must be in secret. The official story is banishment.</p>",
                "prose": "",
                "word_count": 127,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "56188527-1669-40a2-ba2c-eefc85fc5844",
                "name": "Into the wasteland",
                "date": "3578-10-06",
                "dynamic_properties": {},
                "tags": [],
                "summary": "<p>Viggo has no delusions - this is a suicide mission. They are being disposed of. Which grates on him because of his previous experience with Emily.</p>",
                "prose": "",
                "word_count": 0,
                "summary_expanded": false,
                "prose_expanded": false
            },
            {
                "id": "b587163d-5275-4192-9bc7-b7e8c8daf9ff",
                "name": "Emily forges Edward's will",
                "date": "3579-01-22",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            },
            {
                "id": "2e8a8c3a-768e-434e-b347-f3b3be4b15f6",
                "name": "Elle spares Mary and Elizabeth",
                "date": "3579-02-13",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            },
            {
                "id": "16e74488-153b-4c31-9dc5-1836420c4dfc",
                "name": "Emily receives word that Mary and Elizabeth are dead",
                "date": "3579-03-05",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            },
            {
                "id": "05dfcc49-2d04-4d84-a3ba-1553e0b4be25",
                "name": "Emily ascends to the throne",
                "date": "3579-03-11",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            },
            {
                "id": "72c80ad6-95da-43bb-950c-e258878ebe19",
                "name": "Emily is deposed",
                "date": "3579-03-20",
                "dynamic_properties": {},
                "tags": [],
                "summary": "",
                "prose": "",
                "word_count": 0
            }
];

let display = null;
let card_display = null;
let left_filters = { display: null, filters: [] };
let right_filters = { display: null, filters: [] };
let all_properties = [];
let all_tags = [];
let all_operations = ["equal to", "greater-than", "less-than"];
let stats_display = null;
let order_by_display = null;
let order_by_selector = null;
let order_by = "date";

import { Fluent } from "./fluent.js";
const f = Fluent();

import { SaveSystem } from "./save.js";
const save_system = SaveSystem();

export function save_cards() {
    save_system.save(cards);
}

export function load_cards() {
    var file_chooser_modal;
    display_modal(file_chooser_modal = make_file_chooser((file) => save_system.load(file, c => { cards = c; refresh(); destroy_modal(file_chooser_modal); })), () => {});
}

function clear(element) {
    element.innerHTML = "";
}

function add_between(list, item) {
    var r = [];
    for (var x = 0; x < list.length; ++x) {
        if (x != 0) r.push(item);
        r.push(list[x]);
    }
    return r;
}

function make_card_contents(card) {
    return f.div(
        f.div(...add_between(card.tags.map(t => f.div(t).class("tag-button"))), " "),
        f.raw_div(card.summary)
    );
}

function make_card_display(card, sequence, type) {
    var summary_div, prose_div;
    var r = f.div(
        f.div(card.name)._style({fontWeight: "bold"}).grid(1,2,2,3),
        f.div(sequence).grid(1, 3, 2, 4),
        f.button("Edit", () => edit_card(card)).grid(1,4,2,5)._style({justifySelf: "start", alignSelf: "start"}),
        summary_div = make_card_contents(card).grid(2,2,3,6)._style({display: card.summary_expanded ? "block" : "none"}),
        prose_div = f.raw_div(card.prose).grid(3,1,4,6)._style({display: card.prose_expanded ? "block" : "none"}),
        make_expando_button(summary_div, card.summary_expanded, (state) => card.summary_expanded = state).grid(1,5,2,6),
        make_expando_button(prose_div, card.prose_expanded, (state) => card.summary_expanded = state).grid(1,6,2,7)
    )._style({
        gridTemplateColumns: "15px Auto 150px 80px 30px 30px 15px",
        gridTemplateRows: "30px auto"
    });

    if (type == "left" || type == "both")
        r.appendChild(f.div().class("marker").grid(1,1,3,2));
    if (type == "right" || type == "both")
        r.appendChild(f.div().class("marker").grid(1,7,3,8));

    return r;
}

function make_expando_button(controlled_element, expanded, state_callback) {
    var open, closed;

    closed = f.button("<", () => { 
        closed.style.display = "none";
        open.style.display = "block";
        controlled_element.style.display = "block";
        if (state_callback) state_callback(true);
    })._style({display: expanded ? "none" : "block"}).class("arrow-toggle");
    
    open = f.button("V", () => { 
        closed.style.display = "block";
        open.style.display = "none";
        controlled_element.style.display = "none";
        if (state_callback) state_callback(false);
    })._style({display: expanded ? "block" : "none"}).class("arrow-toggle");
    
    return f.div(closed, open)._style({justifySelf: "start", alignSelf: "start"});
}

function refresh_order_by_display() {
    var order_by_value = order_by_selector == null ? "date" : order_by_selector.value;
    clear(order_by_display);
    order_by_display.appendChild(f.div("Order By: ", 
        order_by_selector = f.select(all_properties, order_by_value).handler("change", () => refresh())));
}

function refresh_filter_display(filter_set, side) {
    filter_set.filters = filter_set.filters.filter(f => f.valid());

    clear(filter_set.display);
    filter_set.display.appendChild(
        f.div(
            f.div(side, " Filters",
                f.button("+ Property Filter", () => add_propfilter(filter_set)),
                f.button("+ Tag Filter", () => add_tagfilter(filter_set)),
            ),
            f.div(
                ...filter_set.filters.map(f => make_filter_display(filter_set, f))
            )
        ).class("box")
    );
}

function get_filtered_cards(card_set, filter_set) {
    return card_set.filter(c => {
        for (var filter of filter_set.filters)
            if (!filter.passes(c)) return false;
        return true;
    });
}

function get_minimum_date(left_cards, left_index, right_cards, right_index) {
    if (left_index >= left_cards.length && right_index >= right_cards.length)
        return 0;
    if (left_index >= left_cards.length)
        return right_cards[right_index].date;
    if (right_index >= right_cards.length)
        return left_cards[left_index].date;
    if (left_cards[left_index].date < right_cards[right_index].date)
        return left_cards[left_index].date;
    return right_cards[right_index].date;
}

function refresh() {
    quick_save();
    all_properties = ["name", "date"];
    for (var card of cards) {
        for (var property_name in card.dynamic_properties) {
            if (!card.dynamic_properties.hasOwnProperty(property_name)) continue;
            if (all_properties.indexOf(property_name) === -1)
            all_properties.push(property_name);
        }
    }

    all_tags = [];
    for (var card of cards)
        for (var tag in card.tags)
            if (all_tags.indexOf(card.tags[tag]) === -1)
                all_tags.push(card.tags[tag]);

    refresh_order_by_display();
    refresh_filter_display(left_filters, "Left");
    refresh_filter_display(right_filters, "Right");
    order_by = order_by_selector.value;
    cards.sort((a, b) => a[order_by].localeCompare(b[order_by]));

    clear(card_display);
    var left_cards = get_filtered_cards(cards, left_filters);
    var right_cards = get_filtered_cards(cards, right_filters);

    var current_date = get_minimum_date(left_cards, 0, right_cards, 0);
    var left_index = 0;
    var right_index = 0;

    while (true) {
        var row_type = "none";
        if (left_index >= left_cards.length && right_index >= right_cards.length) break;
        else if (left_index >= left_cards.length) {
            current_date = right_cards[right_index].date;
            row_type = "right";
        }
        else if (right_index >= right_cards.length) {
            current_date = left_cards[left_index].date;
            row_type = "left";
        }
        else {
            current_date = get_minimum_date(left_cards, left_index, right_cards, right_index);
            if (left_cards[left_index].date != current_date)
                row_type = "right";
            else if (right_cards[right_index].date != current_date)
                row_type = "left";
            else 
                row_type = "both";
        }

        if (row_type == "none") {} // ??
        else if (row_type == "left") {
            card_display.appendChild(make_card_display(left_cards[left_index],current_date,row_type).class("timeline"));
            left_index += 1;
        }
        else if (row_type == "right") {
            card_display.appendChild(make_card_display(right_cards[right_index], current_date,row_type).class("timeline"));
            right_index += 1;
        }
        else if (row_type == "both") {
            card_display.appendChild(make_card_display(left_cards[left_index], current_date, row_type).class("timeline"));
            left_index += 1;
            right_index += 1;
        }
    }

    update_stats();
}

function make_filter_display(filter_set, filter) {
    return f.div(filter.display(), f.button("x", () => {
        filter_set.filters = filter_set.filters.filter(x => x !== filter);
        refresh();
    }).modify(e => e.style.float = "right")).class("filter-display-container");
}


function make_blank_card() {
    return {
        id: self.crypto.randomUUID(),
        name: "new card",
        date: 0.0,
        dynamic_properties: {},
        tags: [],
        summary: "",
        prose: ""
    };
}

function make_empty_propfilter() {
    return {
        id: self.crypto.randomUUID(),
        property_name: "",
        property_value: "",
        operation: "equal",
        display: function() {
            return f.raw_div("<i>where</i> " + this.property_name + " <i>is " + this.operation + "</i> " + this.property_value);
        },
        valid: function() {
            if (all_properties.indexOf(this.property_name) === -1)
                return false;
            return true;
        },
        passes: function(card) {
            var value = "";
            if (card.hasOwnProperty(this.property_name)) value = card[this.property_name];
            else if (card.dynamic_properties.hasOwnProperty(this.property_name)) value = card.dynamic_properties[this.property_name];
            else return false;

            if (this.operation == "equal-to")
                return value == this.property_value;
            if (this.operation == "greater-than")
                return value > this.property_value;
            if (this.operation == "less-than")
                return value < this.property_value;
            return false;
        }
    };
}

function make_empty_tagfilter() {
    return {
        id: self.crypto.randomUUID(),
        tag_name: "",
        display: function() {
            return f.raw_div("<i>which is tagged</i> " + this.tag_name);
        },
        valid: function() {
            return true;
        },
        passes: function(card) {
            return card.tags.includes(this.tag_name);
        }
    };
}

function prepare_dynamic_property_editors(card, editor) {
    for (var property_key in card.dynamic_properties) {
        if (!card.dynamic_properties.hasOwnProperty(property_key)) continue;
        var property_editor = make_dynamic_property_editor(card, property_key);
        editor.dynamic_property_editors.push(property_editor);
    }
}

function make_card_editor(card) {
    var editor = {
        current_card: card,
        dynamic_property_editors: [],
        active_tag_editor: null
    };

    prepare_dynamic_property_editors(card, editor);

    editor.element = f.div(
        f.div("CARD ID: " + card.id).class("margin-box"),
        f.div("Name: ", editor.name_editor = f.input(card.name)).class("margin-box"),
        f.div("Date: ", editor.date_editor = f.input(card.date)).class("margin-box"),
        ...editor.dynamic_property_editors,
        editor.new_property_row = f.div(
            f.button("+ Property", 
                () => { 
                    var property_creator = make_dynamic_property_editor(editor.current_card, "new");
                    editor.element.insertBefore(property_creator.element, editor.new_property_row);
                    editor.dynamic_property_editors.push(property_creator);
                }).modify(e => e.style.float = "right")
            ).modify(d => d.style.overflow = "hidden"),
        f.div(editor.tag_list = f.div()).class("margin-box box"),
        f.div("Summary: ", editor.summary_editor_div = make_text_editor(card.summary, (stats) => card.word_count = stats.word_count)),
        f.div("Prose: ", editor.prose_editor_div = make_text_editor(card.prose, (stats) => { card.word_count = stats.word_count; update_stats(); })),
        f.div(
            f.button("Save",
            () => {
                save_values_to_card(editor);
                destroy_modal(editor);
            }).modify(e => e.style.float = "right"),
            f.button("Delete",
            () => {
                cards = cards.filter(c => c !== card);
                destroy_modal(editor);
            }).modify(e => e.style.float = "left")
        ).modify(d => d.style.overflow = "hidden")
    ).class("padded-box");

    editor.summary_editor_div = editor.summary_editor_div.firstChild;
    editor.prose_editor_div = editor.prose_editor_div.firstChild;

    populate_tag_list(editor);
    return editor;
}

function make_text_editor(contents, stats_func) {
    var blur_func = function(event, editable) {
        var stats = { word_count: count_words(contents_div.textContent) };
        stats_div.innerText = "Words: " + stats.word_count;
        if (stats_func) stats_func(stats);
    };

    var contents_div;
    var stats_div;
    var r = f.div(
        contents_div = f.raw_div(contents)._style({padding: "4px"}).class("editable margin-box"),
        stats_div = f.div("STATS")
    )._style({gridTemplateRows: "auto 40px"});
    r._medium_editor = new MediumEditor(contents_div);
    r._medium_editor.subscribe('blur', blur_func);

    blur_func();
    return r;
}

function count_words(s){
    s = s.replace(/(^\s*)|(\s*$)/gi,"");    // exclude  start and end white-space
    s = s.replace(/[ ]{2,}/gi," ");         // 2 or more space to 1
    s = s.replace(/\n /,"\n");              // exclude newline with a start spacing
    return s.split(' ').filter(function(str){return str!="";}).length;
}

function update_stats() {
    var total_prose_words = 0;
    for (var card of cards) 
        if (card.hasOwnProperty("word_count")) 
            total_prose_words += card.word_count;
    clear(stats_display);
    stats_display.appendChild(f.div(
        f.div("Cards: " + cards.length),
        f.div("Words: " + total_prose_words)
    ));
}

function populate_tag_list(editor) {
    clear(editor.tag_list);
    editor.tag_list.appendChild(f.div(
        f.button("+ Tag", () => { 
            if (editor.active_tag_editor != null) return;
            var new_tag_editor = f.input("");
            var editor_row =  f.div(new_tag_editor);
            new_tag_editor.onchange = () => {
                editor.current_card.tags.push(new_tag_editor.value);
                populate_tag_list(editor);
                editor.active_tag_editor = null;
            };
            editor.tag_list.appendChild(editor_row);
            new_tag_editor.focus();
            editor.active_tag_editor = new_tag_editor;
        }),
        ...editor.current_card.tags.map(t => f.div(
            t,
            f.button("X", () => {
                editor.current_card.tags = editor.current_card.tags.filter(t2 => t2 != t);
                populate_tag_list(editor);
            }).class("hidden-button")
        ).class('tag-button'))));
}

function make_propfilter_editor(filter) {
    var editor = {
        current_filter: filter,
    };
    
    editor.element = f.div(
        f.div(
            editor.property_name_field = f.select(all_properties, filter.property_name),
            editor.operation_field = f.select(all_operations, filter.operation),
            editor.property_value_field = f.input(filter.property_value)
        ),
        f.div(
            f.button("Save", () => {
                editor.current_filter.property_name = editor.property_name_field.value;
                editor.current_filter.operation = editor.operation_field.value;
                editor.current_filter.property_value = editor.property_value_field.value;
                destroy_modal(editor)
            }).modify(e => e.style.float = "left")
        ).modify(e => e.style.overflow = "hidden")
    ).class("box");

    return editor;
}

function make_tagfilter_editor(filter) {
    var editor = {
        current_filter: filter,
    };
    
    editor.element = f.div(
        f.div(
            editor.tag_name_field = f.select(all_tags, filter.tag_name)
        ),
        f.div(
            f.button("Save", () => {
                editor.current_filter.tag_name = editor.tag_name_field.value;
                destroy_modal(editor)
            }).modify(e => e.style.float = "left")
        ).modify(e => e.style.overflow = "hidden")
    ).class("box");

    return editor;
}

function make_file_chooser(onchosen) {
    var file;
    var modal;
    modal = {
        element: f.div(
            f.div(file = f.file()),
            f.div(
                f.button("cancel", () => destroy_modal(modal)),
                f.button("load", () => onchosen(file.files[0]))
            )
        )
    };
    return modal;
}

function make_dynamic_property_editor(card, property_key) {
    var r = {
        property_name_field: f.input(property_key),
        property_value_field: f.input(card.dynamic_properties.hasOwnProperty(property_key) ? card.dynamic_properties[property_key] : "")
    };

    r.element = f.div(r.property_name_field, r.property_value_field);
    return r;
}

function save_values_to_card(editor) {
    console.log(editor.current_card);
    editor.current_card.name = editor.name_editor.value;
    editor.current_card.date = editor.date_editor.value;
    editor.current_card.summary = editor.summary_editor_div.innerHTML;
    editor.current_card.prose = editor.prose_editor_div.innerHTML;
    
    editor.current_card.dynamic_properties = {};
    for (var property_editor of editor.dynamic_property_editors)
        editor.current_card.dynamic_properties[property_editor.property_name_field.value] = property_editor.property_value_field.value;    
}

function display_modal(modal, onclose) {
    var wrapper = document.createElement('div');
    wrapper.className = 'modal';
    var content = document.createElement('div');
    content.className = 'modal-content';
    wrapper.appendChild(content);
    content.appendChild(modal.element);
    display.appendChild(wrapper);
    wrapper.style.display = 'block';
    modal.__wrapped_modal_element = wrapper;
    modal.__onclose = onclose;
}

function destroy_modal(modal) {
    if (modal.__onclose != undefined) modal.__onclose();
    modal.__wrapped_modal_element.remove();    
}

export function edit_card(card) {
    var card_editor = make_card_editor(card);
    display_modal(card_editor, refresh);
    card_editor.name_editor.focus();
}

export function edit_propfilter(filter) {
    var filter_editor = make_propfilter_editor(filter);
    display_modal(filter_editor, refresh);
}

export function edit_tagfilter(filter) {
    var filter_editor = make_tagfilter_editor(filter);
    display_modal(filter_editor, refresh);
}

export function add_card() {
    var new_card = make_blank_card();
    cards.push(new_card);
    edit_card(new_card);   
}

export function add_propfilter(filter_set) {
    var new_filter = make_empty_propfilter();
    filter_set.filters.push(new_filter);
    edit_propfilter(new_filter);
}

export function add_tagfilter(filter_set) {
    var new_filter = make_empty_tagfilter();
    filter_set.filters.push(new_filter);
    edit_tagfilter(new_filter);
}

function quick_save() {
    save_system.save_local(cards);
}

export function initialize_cards(_display) {
    display = _display;
    display.appendChild(
        f.div(
            f.div(
                f.div(
                    f.div(
                        f.div(
                            f.button("+ Card", add_card),
                            f.button("Save", save_cards),
                            f.button("Load", load_cards),
                            f.button("Clear", () => { cards = []; refresh(); })
                        )._style({marginBottom: "4px"}),
                        order_by_display = f.div(

                        )
                    ),
                    left_filters.display = f.div().class("margin-box"),
                    right_filters.display = f.div().class("margin-box"),
                    stats_display = f.div("Stats").class("margin-box box")
                ).class("topbar"),
                card_display = f.div()
            ),
            f.div(
                f.h4("Todo"),
                f.ul(
                    f.li("And/Or filter combinations")
                )
            )
        )
    );

    var saved_local_data = save_system.load_local();
    console.log(saved_local_data);
    if (saved_local_data != undefined && saved_local_data.hasOwnProperty("CARDS") && saved_local_data.CARDS.length > 0) {
        console.log("Loaded Cards");
        cards = saved_local_data.CARDS;
    }

    refresh();
}

